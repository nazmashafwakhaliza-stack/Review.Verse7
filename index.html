<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviewVerse — Ruang Resensi Karya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #0f172a; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pill-active { background-color: #4f46e5 !important; color: white !important; border-color: #4f46e5 !important; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        
        /* Animasi Transisi Halaman */
        .page-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animasi Hapus */
        .delete-slide { animation: slideOut 0.5s forwards cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }

        /* Explore Style */
        .explore-item { border-radius: 28px; overflow: hidden; position: relative; aspect-ratio: 1/1; }
        .explore-overlay { background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 60%); }
    </style>
</head>
<body class="pb-28">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative">
        
        <!-- Header -->
        <header class="sticky top-0 z-40 glass border-b p-5 flex justify-between items-center">
            <div class="flex items-center gap-2" onclick="router.navigate('home')">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-100">
                    <i data-lucide="layout-template" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-extrabold tracking-tighter text-slate-900">ReviewVerse</h1>
            </div>
            <button onclick="router.navigate('profile')" class="w-10 h-10 rounded-full border-2 border-slate-100 overflow-hidden bg-slate-50">
                <img id="header-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full object-cover">
            </button>
        </header>

        <!-- Area Konten Utama -->
        <main id="main-content" class="p-5 page-fade">
            <!-- Konten akan dimuat di sini -->
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md glass border-t px-8 py-5 flex justify-between items-center z-50 rounded-t-[35px] shadow-[0_-10px_40px_rgba(0,0,0,0.04)]">
            <button onclick="router.navigate('home')" class="nav-btn text-slate-400 flex flex-col items-center gap-1" id="nav-home">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Beranda</span>
            </button>
            <button onclick="router.navigate('explore')" class="nav-btn text-slate-400 flex flex-col items-center gap-1" id="nav-explore">
                <i data-lucide="search" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Jelajah</span>
            </button>
            <button onclick="router.navigate('write')" class="bg-indigo-600 text-white w-14 h-14 rounded-full -mt-14 shadow-2xl shadow-indigo-200 flex items-center justify-center border-4 border-white active:scale-90 transition-transform">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
            <button onclick="router.navigate('categories')" class="nav-btn text-slate-400 flex flex-col items-center gap-1" id="nav-categories">
                <i data-lucide="grid" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Kategori</span>
            </button>
            <button onclick="router.navigate('profile')" class="nav-btn text-slate-400 flex flex-col items-center gap-1" id="nav-profile">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Profil</span>
            </button>
        </nav>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 z-[60] hidden bg-black/60 backdrop-blur-md p-6 flex items-end sm:items-center justify-center">
            <div class="bg-white w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl page-fade">
                <div id="modal-content"></div>
            </div>
        </div>

    </div>

    <script>
        // --- KONFIGURASI DATA ---
        const GENRES = {
            music: ['Pop', 'Rock', 'Jazz', 'R&B', 'EDM', 'Hip-Hop', 'Country', 'Reggae', 'Metal', 'Dangdut'],
            film: ['Aksi', 'Komedi', 'Drama', 'Horor', 'Petualangan', 'Romansa', 'Fiksi Ilmiah (Sci-Fi)', 'Fantasi', 'Thriller'],
            novel: ['Romance', 'Fantasi', 'Fiksi Ilmiah (Sci-Fi)', 'Horor', 'Misteri', 'Kriminal', 'Petualangan', 'Sejarah', 'Komedi']
        };

        let db = {
            user: {
                name: "Petualang Seni",
                bio: "Penikmat cerita di balik layar dan setiap baris nada.",
                avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
                favGenres: { film: ['Fiksi Ilmiah (Sci-Fi)'], music: ['Dangdut'], novel: ['Fantasi'] }
            },
            works: [
                { id: '1', type: 'film', title: 'Inside Out 2', creator: 'Kelsey Mann', genre: 'Komedi', rating: 5, desc: 'Petualangan emosi yang luar biasa mendalam.', img: 'https://images.unsplash.com/photo-1536440136628-849c177e76a1?w=400', isUser: false },
                { id: '2', type: 'film', title: 'Spider-Verse', creator: 'Joaquim Dos Santos', genre: 'Aksi', rating: 5, desc: 'Visual paling memukau dekade ini.', img: 'https://images.unsplash.com/photo-1635805737707-575885ab0820?w=400', isUser: false },
                { id: '3', type: 'novel', title: 'Sherlock Holmes', creator: 'Sir Arthur Conan Doyle', genre: 'Misteri', rating: 5, desc: 'Legenda detektif yang tak lekang oleh waktu.', img: 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?w=400', isUser: false },
                { id: '4', type: 'novel', title: 'The Hobbit', creator: 'J.R.R. Tolkien', genre: 'Fantasi', rating: 4, desc: 'Awal dari saga Middle-earth yang agung.', img: 'https://images.unsplash.com/photo-1629992101753-56d196c8aced?w=400', isUser: false },
                { id: '5', type: 'music', title: 'The Tortured Poets', creator: 'Taylor Swift', genre: 'Pop', rating: 5, desc: 'Lirik yang tajam dan emosional.', img: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=400', isUser: false },
                { id: '6', type: 'music', title: 'Lowkey', creator: 'NIKI', genre: 'R&B', rating: 4, desc: 'Vokal yang lembut dan melodi yang adiktif.', img: 'https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=400', isUser: false }
            ],
            favorites: []
        };

        let activeFilter = { cat: 'all', genre: 'all' };

        // --- ROUTER SYSTEM ---
        const router = {
            page: 'home',
            navigate(p) {
                this.page = p;
                this.render();
                window.scrollTo(0,0);
            },
            render() {
                const main = document.getElementById('main-content');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-indigo-600', 'text-slate-400'));
                const activeNav = document.getElementById(`nav-${this.page}`);
                if(activeNav) activeNav.classList.replace('text-slate-400', 'text-indigo-600');

                switch(this.page) {
                    case 'home': main.innerHTML = pages.home(); break;
                    case 'explore': main.innerHTML = pages.explore(); break;
                    case 'write': main.innerHTML = pages.write(); break;
                    case 'categories': main.innerHTML = pages.categories(); break;
                    case 'profile': main.innerHTML = pages.profile(); break;
                }
                lucide.createIcons();
            }
        };

        // --- UI PAGES ---
        const pages = {
            home: () => {
                const items = db.works.filter(w => (activeFilter.cat === 'all' || w.type === activeFilter.cat) && (activeFilter.genre === 'all' || w.genre === activeFilter.genre));
                return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-black tracking-tight">Karya Terbaru</h2>
                            <button onclick="resetFilters()" class="text-[10px] font-black text-indigo-600 border border-indigo-100 px-3 py-1 rounded-full uppercase">Reset Filter</button>
                        </div>
                        
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                            ${['all', 'film', 'novel', 'music'].map(c => `
                                <button onclick="setFilter('cat', '${c}')" class="px-5 py-2.5 rounded-2xl border text-[10px] font-black uppercase tracking-widest transition-all ${activeFilter.cat === c ? 'pill-active shadow-lg shadow-indigo-100' : 'bg-white text-slate-400 border-slate-100'}">
                                    ${c === 'all' ? 'Semua' : c}
                                </button>
                            `).join('')}
                        </div>

                        ${activeFilter.cat !== 'all' ? `
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar animate-in">
                            <button onclick="setFilter('genre', 'all')" class="px-4 py-2 rounded-xl text-[10px] font-bold border ${activeFilter.genre === 'all' ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-400 border-transparent'}">Semua ${activeFilter.cat}</button>
                            ${GENRES[activeFilter.cat].map(g => `
                                <button onclick="setFilter('genre', '${g}')" class="px-4 py-2 rounded-xl text-[10px] font-bold border whitespace-nowrap ${activeFilter.genre === g ? 'bg-indigo-600 text-white' : 'bg-slate-50 text-slate-400 border-transparent'}">${g}</button>
                            `).join('')}
                        </div>
                        ` : ''}

                        <div class="space-y-5">
                            ${items.length ? items.map(w => renderCard(w)).join('') : '<p class="text-center py-20 text-slate-300 italic text-sm">Belum ada resensi untuk kategori ini.</p>'}
                        </div>
                    </div>
                `;
            },
            explore: () => {
                return `
                    <div class="space-y-6">
                        <div class="bg-indigo-600 rounded-[40px] p-8 text-white relative overflow-hidden shadow-xl shadow-indigo-100">
                            <i data-lucide="compass" class="absolute -right-6 -top-6 w-32 h-32 opacity-10"></i>
                            <h2 class="text-3xl font-black leading-tight">Jelajahi<br>Inspirasi</h2>
                            <p class="text-xs text-indigo-100 mt-2 font-medium">Temukan karya terbaik dari berbagai genre pilihan</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            ${db.works.map(w => `
                                <div class="explore-item group" onclick="viewDetail('${w.id}')">
                                    <img id="exp-img-${w.id}" src="${w.img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                                    <div class="explore-overlay absolute inset-0 flex flex-col justify-end p-5">
                                        <span class="text-[8px] font-black text-indigo-400 uppercase tracking-widest">${w.genre}</span>
                                        <h3 class="text-white text-sm font-bold leading-tight line-clamp-2">${w.title}</h3>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            write: () => `
                <div class="space-y-6 pb-12">
                    <h2 class="text-2xl font-black">Tulis Resensi</h2>
                    <form onsubmit="handlePublish(event)" class="space-y-4">
                        <div id="upload-preview" onclick="document.getElementById('file-input').click()" class="aspect-video w-full bg-slate-50 border-2 border-dashed border-slate-200 rounded-[35px] flex flex-col items-center justify-center text-slate-400 cursor-pointer overflow-hidden group transition-all hover:bg-slate-100">
                            <i data-lucide="image-plus" class="w-10 h-10 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest">Ketuk Untuk Pilih Poster</span>
                            <input type="file" id="file-input" class="hidden" accept="image/*" onchange="previewPoster(event)">
                        </div>

                        <div class="bg-slate-50 p-6 rounded-[35px] space-y-4 shadow-inner">
                            <input type="text" id="w-title" required placeholder="Judul Karya" class="w-full bg-white px-5 py-4 rounded-2xl border-none text-sm font-bold shadow-sm focus:ring-2 focus:ring-indigo-600">
                            <input type="text" id="w-creator" required placeholder="Nama Pembuat (Sutradara/Penulis/Artis)" class="w-full bg-white px-5 py-4 rounded-2xl border-none text-sm font-bold shadow-sm focus:ring-2 focus:ring-indigo-600">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <select id="w-cat" onchange="syncGenreOptions(this.value)" class="bg-slate-50 px-5 py-4 rounded-2xl border-none text-[10px] font-black uppercase tracking-widest appearance-none shadow-sm">
                                <option value="film">FILM</option>
                                <option value="novel">NOVEL</option>
                                <option value="music">MUSIK</option>
                            </select>
                            <select id="w-genre" class="bg-slate-50 px-5 py-4 rounded-2xl border-none text-[10px] font-black uppercase tracking-widest shadow-sm">
                                ${GENRES.film.map(g => `<option value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>

                        <div class="bg-indigo-50 p-5 rounded-2xl flex items-center justify-between">
                            <span class="text-[10px] font-black text-indigo-600 uppercase tracking-widest">Beri Rating</span>
                            <div class="flex gap-2">
                                <input type="range" id="w-rate" min="1" max="5" value="5" class="accent-indigo-600">
                                <span id="rate-val" class="text-sm font-black text-indigo-600">5</span>
                            </div>
                        </div>

                        <textarea id="w-desc" rows="5" required placeholder="Tuliskan pengalamanmu menikmati karya ini..." class="w-full bg-slate-50 px-6 py-5 rounded-[35px] border-none text-sm italic shadow-inner focus:ring-2 focus:ring-indigo-600"></textarea>

                        <button type="submit" class="w-full py-5 bg-indigo-600 text-white font-black rounded-[35px] shadow-xl shadow-indigo-100 active:scale-95 transition-all">PUBLIKASIKAN RESENSI</button>
                    </form>
                </div>
            `,
            categories: () => `
                <div class="space-y-4">
                    <h2 class="text-2xl font-black">Cari Berdasarkan</h2>
                    ${Object.keys(GENRES).map(c => `
                        <div onclick="setFilter('cat', '${c}'); router.navigate('home')" class="relative h-32 rounded-[35px] overflow-hidden group shadow-lg cursor-pointer">
                            <img src="https://images.unsplash.com/photo-${c==='film'?'1485846234645-a62644f84728':c==='novel'?'1544947950-fa07a98d237f':'1511671782779-c97d3d27a1d4'}?w=600" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                            <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/80 to-transparent flex flex-col justify-center px-8">
                                <h3 class="text-2xl font-black text-white capitalize tracking-tight">${c}</h3>
                                <p class="text-indigo-200 text-[10px] font-bold uppercase tracking-widest mt-1">Eksplorasi Semua Genre</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `,
            profile: () => {
                const myReviews = db.works.filter(w => w.isUser);
                const favoriteWorks = db.works.filter(w => db.favorites.includes(w.id));
                return `
                <div class="space-y-8 pb-10">
                    <div class="flex flex-col items-center pt-8 gap-5">
                        <div class="relative group">
                            <div class="w-32 h-32 rounded-full border-4 border-indigo-50 p-1 bg-white shadow-xl">
                                <img id="p-avatar" src="${db.user.avatar}" class="w-full h-full rounded-full object-cover">
                            </div>
                            <button onclick="document.getElementById('file-avatar').click()" class="absolute bottom-1 right-1 bg-indigo-600 text-white p-2.5 rounded-full border-2 border-white shadow-xl hover:scale-110 transition-transform">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                            </button>
                            <input type="file" id="file-avatar" class="hidden" onchange="handleAvatar(event)">
                        </div>
                        <div class="text-center px-10">
                            <h2 class="text-2xl font-black text-slate-800 tracking-tight">${db.user.name}</h2>
                            <p class="text-xs text-slate-400 font-bold mt-2 leading-relaxed italic">"${db.user.bio}"</p>
                        </div>
                        <div class="flex gap-10">
                            <div class="text-center">
                                <span id="stat-resensi" class="block text-xl font-black text-indigo-600">${myReviews.length}</span>
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Resensi</span>
                            </div>
                            <div class="text-center">
                                <span class="block text-xl font-black text-indigo-600">${db.favorites.length}</span>
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Favorit</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-8 rounded-[40px] space-y-4 shadow-inner">
                        <div class="flex justify-between items-center">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Preferensi Genre</h3>
                            <button onclick="openPrefModal()" class="text-[10px] font-black text-indigo-600 border-b-2 border-indigo-600">UBAH BIODATA</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${Object.keys(db.user.favGenres).map(cat => 
                                db.user.favGenres[cat].map(g => `<span class="px-4 py-2 bg-white rounded-2xl text-[9px] font-black border border-slate-100 text-slate-600 uppercase shadow-sm">${cat}: ${g}</span>`).join('')
                            ).join('')}
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-sm font-black text-slate-800 border-b border-slate-100 pb-3">Riwayat Ulasan</h3>
                        <div class="space-y-3">
                            ${myReviews.length ? myReviews.map(r => `
                                <div id="item-${r.id}" class="flex items-center gap-4 bg-white border border-slate-50 p-4 rounded-3xl transition-all hover:shadow-lg">
                                    <img id="p-img-${r.id}" src="${r.img}" class="w-16 h-16 object-cover rounded-2xl shadow-sm">
                                    <div class="flex-1">
                                        <h4 class="text-xs font-black text-slate-900 line-clamp-1">${r.title}</h4>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-1">${r.genre}</p>
                                    </div>
                                    <button onclick="handleDeleteReview('${r.id}')" class="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            `).join('') : '<p class="text-center py-10 text-slate-300 italic text-sm">Belum ada ulasan pribadi.</p>'}
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-sm font-black text-slate-800 border-b border-slate-100 pb-3">Favorit Saya</h3>
                        <div class="grid grid-cols-3 gap-3">
                            ${favoriteWorks.length ? favoriteWorks.map(f => `
                                <div class="aspect-[3/4] rounded-2xl overflow-hidden shadow-sm" onclick="viewDetail('${f.id}')">
                                    <img id="fav-img-${f.id}" src="${f.img}" class="w-full h-full object-cover">
                                </div>
                            `).join('') : '<div class="col-span-3 py-6 text-center text-slate-300 text-[10px] font-bold italic">Belum ada karya favorit</div>'}
                        </div>
                    </div>
                </div>
                `;
            }
        };

        // --- COMPONENTS ---
        function renderCard(w) {
            const isFav = db.favorites.includes(w.id);
            return `
                <div class="bg-white border border-slate-50 rounded-[35px] overflow-hidden shadow-sm transition-all hover:shadow-xl relative group">
                    <!-- Tombol Edit Pensil (Hanya muncul saat hover atau klik di pojok) -->
                    <button onclick="quickEditPoster('${w.id}', event)" class="absolute top-4 left-4 w-9 h-9 bg-white/20 backdrop-blur-md rounded-full text-white flex items-center justify-center z-20 opacity-0 group-hover:opacity-100 transition-opacity border border-white/30">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                    </button>
                    
                    <div class="aspect-video relative overflow-hidden" onclick="viewDetail('${w.id}')">
                        <img id="img-${w.id}" src="${w.img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <div class="absolute bottom-5 left-6 right-16">
                            <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${w.type} • ${w.genre}</span>
                            <h3 class="text-xl font-black text-white leading-tight tracking-tight">${w.title}</h3>
                        </div>
                        <button onclick="toggleFav('${w.id}', event)" class="absolute bottom-5 right-6 w-11 h-11 rounded-full flex items-center justify-center transition-all ${isFav ? 'bg-red-500 text-white shadow-lg shadow-red-200' : 'bg-white/20 backdrop-blur-md text-white border border-white/30'}">
                            <i data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-current' : ''}"></i>
                        </button>
                    </div>

                    <div class="p-6 flex justify-between items-center bg-white" onclick="viewDetail('${w.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400">
                                <i data-lucide="user" class="w-4 h-4"></i>
                            </div>
                            <div class="flex flex-col">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">Karya Dari</p>
                                <p class="text-xs font-bold text-slate-800 mt-1">${w.creator}</p>
                            </div>
                        </div>
                        <div class="flex gap-1 text-amber-400">
                            ${Array(w.rating).fill().map(() => '<i data-lucide="star" class="w-3 h-3 fill-current"></i>').join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- HANDLERS ---
        function setFilter(k, v) {
            activeFilter[k] = v;
            if(k === 'cat') activeFilter.genre = 'all';
            router.render();
        }

        function resetFilters() {
            activeFilter = { cat: 'all', genre: 'all' };
            router.render();
        }

        function syncGenreOptions(cat) {
            document.getElementById('w-genre').innerHTML = GENRES[cat].map(g => `<option value="${g}">${g}</option>`).join('');
        }

        function previewPoster(e) {
            const r = new FileReader();
            r.onload = () => {
                const box = document.getElementById('upload-preview');
                box.innerHTML = `<img src="${r.result}" class="w-full h-full object-cover">`;
                box.dataset.img = r.result;
            };
            r.readAsDataURL(e.target.files[0]);
        }

        function handlePublish(e) {
            e.preventDefault();
            const poster = document.getElementById('upload-preview').dataset.img || 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400';
            const newRes = {
                id: 'w-' + Date.now(),
                type: document.getElementById('w-cat').value,
                title: document.getElementById('w-title').value,
                creator: document.getElementById('w-creator').value,
                genre: document.getElementById('w-genre').value,
                rating: parseInt(document.getElementById('w-rate').value),
                desc: document.getElementById('w-desc').value,
                img: poster,
                isUser: true
            };
            db.works.unshift(newRes);
            router.navigate('home');
            showToast("Resensi Berhasil Diterbitkan!");
        }

        function handleDeleteReview(id) {
            const item = document.getElementById(`item-${id}`);
            item.classList.add('delete-slide');
            setTimeout(() => {
                db.works = db.works.filter(w => w.id !== id);
                db.favorites = db.favorites.filter(fid => fid !== id);
                router.render();
                showToast("Ulasan dihapus");
            }, 500);
        }

        function quickEditPoster(id, e) {
            e.stopPropagation();
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (ev) => {
                const r = new FileReader();
                r.onload = () => {
                    const work = db.works.find(w => w.id === id);
                    if(work) {
                        work.img = r.result;
                        // Perbarui permanen di semua tampilan
                        const img = document.getElementById(`img-${id}`);
                        const pImg = document.getElementById(`p-img-${id}`);
                        const expImg = document.getElementById(`exp-img-${id}`);
                        const favImg = document.getElementById(`fav-img-${id}`);
                        if(img) img.src = r.result;
                        if(pImg) pImg.src = r.result;
                        if(expImg) expImg.src = r.result;
                        if(favImg) favImg.src = r.result;
                        showToast("Poster Diperbarui Permanen!");
                    }
                };
                r.readAsDataURL(ev.target.files[0]);
            };
            input.click();
        }

        function toggleFav(id, e) {
            e.stopPropagation();
            if(db.favorites.includes(id)) {
                db.favorites = db.favorites.filter(fid => fid !== id);
            } else {
                db.favorites.push(id);
                showToast("Berhasil Masuk Favorit");
            }
            router.render();
        }

        function handleAvatar(e) {
            const r = new FileReader();
            r.onload = () => {
                db.user.avatar = r.result;
                document.getElementById('p-avatar').src = r.result;
                document.getElementById('header-avatar').src = r.result;
                showToast("Foto Profil Diperbarui!");
            };
            r.readAsDataURL(e.target.files[0]);
        }

        function viewDetail(id) {
            const w = db.works.find(x => x.id === id);
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="relative aspect-[4/5]">
                    <img src="${w.img}" class="w-full h-full object-cover">
                    <button onclick="closeModal()" class="absolute top-6 right-6 w-11 h-11 bg-black/40 backdrop-blur rounded-full flex items-center justify-center text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                    <div class="absolute bottom-0 inset-x-0 p-10 bg-gradient-to-t from-black via-black/40 to-transparent text-white">
                        <span class="px-3 py-1 bg-indigo-600 text-[9px] font-black rounded-full uppercase tracking-widest">${w.genre}</span>
                        <h2 class="text-3xl font-black mt-3 leading-tight tracking-tighter">${w.title}</h2>
                        <p class="text-sm font-bold text-white/70 mt-2">Dibuat Oleh: ${w.creator}</p>
                    </div>
                </div>
                <div class="p-10 space-y-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600">
                            <i data-lucide="info" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Tentang Karya</p>
                            <div class="flex text-amber-400 mt-0.5">${'★'.repeat(w.rating)}</div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed italic border-l-4 border-indigo-100 pl-5">"${w.desc}"</p>
                    <button onclick="closeModal()" class="w-full py-5 bg-slate-900 text-white font-black rounded-3xl shadow-xl shadow-slate-200 active:scale-95 transition-transform">Selesai Membaca</button>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function openPrefModal() {
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="p-10 space-y-8 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-black tracking-tighter">Profil & Preferensi</h2>
                        <button onclick="closeModal()" class="text-slate-400"><i data-lucide="x-circle" class="w-7 h-7"></i></button>
                    </div>
                    
                    <div class="space-y-4">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Biodata Kamu</p>
                        <textarea id="edit-bio" class="w-full bg-slate-50 p-4 rounded-2xl border-none text-xs italic shadow-inner">${db.user.bio}</textarea>
                    </div>

                    ${Object.keys(GENRES).map(cat => `
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Genre Favorit ${cat}</h3>
                            <div class="flex flex-wrap gap-2">
                                ${GENRES[cat].map(g => {
                                    const active = db.user.favGenres[cat].includes(g);
                                    return `<button onclick="togglePref('${cat}', '${g}', this)" class="px-4 py-2.5 rounded-2xl border text-[10px] font-bold transition-all ${active ? 'bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-100' : 'bg-white text-slate-500 border-slate-100'}">${g}</button>`;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                    
                    <button onclick="saveProfile()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-[30px] mt-6 shadow-xl shadow-indigo-100">SIMPAN PERUBAHAN</button>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function togglePref(cat, g, btn) {
            if(db.user.favGenres[cat].includes(g)) {
                db.user.favGenres[cat] = db.user.favGenres[cat].filter(x => x !== g);
                btn.className = "px-4 py-2.5 rounded-2xl border text-[10px] font-bold bg-white text-slate-500 border-slate-100";
            } else {
                db.user.favGenres[cat].push(g);
                btn.className = "px-4 py-2.5 rounded-2xl border text-[10px] font-bold bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-100";
            }
        }

        function saveProfile() {
            db.user.bio = document.getElementById('edit-bio').value;
            closeModal();
            router.render();
            showToast("Biodata Diperbarui!");
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function showToast(m) {
            const t = document.createElement('div');
            t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-8 py-4 rounded-full text-[10px] font-black z-[100] shadow-2xl page-fade";
            t.innerText = m;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 2500);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            router.render();
            document.addEventListener('input', (e) => {
                if(e.target.id === 'w-rate') document.getElementById('rate-val').innerText = e.target.value;
            });
        });
    </script>
</body>
</html>
